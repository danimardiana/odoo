<?xml version="1.0" encoding="UTF-8" ?>
<odoo>
    <!-- Inherit Form View to add start date and end date fields -->
    <record id="view_move_form_inherit_add_fields" model="ir.ui.view">
        <field name="name">view.move.form.inherit.add.fields</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_move_form"/>
        <field name="arch" type="xml">
            <xpath expr="//form" position="attributes">
                 <attribute name="create">false</attribute>
            </xpath>
            <!-- EMAIL BUTTON -->
            <xpath expr="//button[@name='action_invoice_sent']" position="replace">
                    <!-- Send (only invoices) -->
                <button name="action_invoice_sent" type="object" string="Send &amp; Print"  class="oe_highlight" groups="base.group_user"/> 
                <button name="action_reminder_sent" type="object" string="Email Reminder"  class="oe_highlight" groups="base.group_user"/>
            </xpath>
            <xpath expr="//field[@name='invoice_date']" position="replace">
                <field name="post_date"/>
                <field name="create_date" string="Creation Date"/>
            </xpath>
            <xpath expr="//label[@for='invoice_date']" position="replace">
                <!-- Removing label for native Invoice Date -->
            </xpath>
            <field name="company_id" position="after">
                <field name="mgmt_company"/>
                <field name="invoice_period_verbal"/>
                <field name="accounting_notes" readonly="0"/>
                <field name="unique_billing_note"/>
            </field>
            <xpath expr="//field[@name='line_ids']/tree//field[@name='analytic_account_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='line_ids']/tree//field[@name='analytic_tag_ids']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_line_ids']/tree//field[@name='analytic_account_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_line_ids']/tree//field[@name='analytic_tag_ids']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_line_ids']/tree//field[@name='account_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_line_ids']/tree//field[@name='quantity']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>
            <xpath expr="//field[@name='invoice_line_ids']/tree//field[@name='product_id']"
                   position="after">
                <field name="subscription_start_date" invisible="1"/>
                <field name="subscription_end_date" invisible="1"/>
                <field name="category_id"/>
                <field name="description"/>
            </xpath>
            <xpath expr="//notebook" position="inside">
                <page string="Subscription Lines" name="subscription_lines">
                    <field name="subscription_line_ids">
                            <tree>
                                <field name="product_id"/>
                                <field name="start_date"/>
                                <field name="end_date"/>
                                <field name="name"/>
                                <field name="quantity"/>
                                <field name="price_unit"/>
                                <field name="discount"/>
                                <field name="price_subtotal"/>
                            </tree>
                    </field>
                </page>
                <page string="Billing Contacts" name="billing_contacts">   
                    <field name="related_billing_contact_ids">     
                        <tree>
                            <field name="name"/>
                            <field name="contact_type_ids" widget="many2many_tags"/>
                            <field name="email"/>
                        </tree>
                    </field>            
                </page>                
            </xpath>            
            <xpath expr="//group[@name='sale_info_group']//field[@name='invoice_user_id']" position="after">
                <field name="account_user_id"/>
                <field name="secondary_user_id"/>
                <field name="national_user_id"/>
            </xpath>  
            <xpath expr="//group[@name='sale_info_group']//field[@name='invoice_user_id']" position="attributes">
                <attribute name="invisible">1</attribute>
            </xpath>  
            <xpath expr="//group[@name='sale_info_group']" position="after">
                <group string="CO-OP" name="co_op_group" >
                    <field name="is_co_op"/>
                </group>
            </xpath>                        
            <xpath expr="//header//button[@name='action_post']" position="after">
                <button name="button_approve_invoice" string="Approve invoice" class="oe_highlight" type="object"
                        groups="account.group_account_invoice"
                        attrs="{'invisible': ['|',('state', '!=', 'draft'),('type','in',('out_refund','in_refund'))]}"/>
                <button name="button_approve_invoice" string="Approve Credit Note" class="oe_highlight" type="object"
                        groups="account.group_account_invoice"
                        attrs="{'invisible': ['|',('state', '!=', 'draft'),('type','not in',('out_refund','in_refund'))]}"/>
            </xpath>
            <xpath expr="//header//button[@name='button_draft']" position="attributes">
                <attribute name="attrs">{'invisible' : ['|', ('restrict_mode_hash_table', '=', True),
                ('state', 'not in', ('approved_draft','email_sent','posted', 'cancel'))]}</attribute>
            </xpath>
            <xpath expr="//header//button[@name='action_post']" position="attributes">
                <attribute name="attrs">{'invisible': [('state', 'not in', ('approved_draft'))]}</attribute>
            </xpath>
            <xpath expr="//group[@id='other_tab_group']" position="inside">
                <group string="Greystar Info"
                       name="greystar_info_group"
                       attrs="{'invisible': [('type', 'not in', ('out_invoice', 'out_refund', 'in_invoice', 'in_refund'))]}">
                    <field name="yardi_code" readonly="0"/>
                    <field name="master_id" readonly="0"/>
                </group>
            </xpath>
            <xpath expr="//header//field[@name='state']" position="replace">
                <field name="state" widget="statusbar" statusbar_visible="draft,draft_approved,posted,email_sent"/>
            </xpath>
        </field>
    </record>

    <record id="view_account_invoice_filter_inherit_clx_invoice_policy" model="ir.ui.view">
        <field name="name">mgmt.company.account.invoice.search</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <xpath expr="//filter[@name='myinvoices']" position="after">
                <separator/>
                <filter name="mgmt_company" string="Management Company" domain="[('mgmt_company','!=',False)]"/>
                <filter name="unique_billing_note" string="Unique Billing Note" domain="[('unique_billing_note','=',True)]"/>
            </xpath>
            <xpath expr="//group" position="inside">
                <filter name="mgmt_company" string="Management Company" context="{'group_by': 'mgmt_company'}"/>
            </xpath>
            <xpath expr="//group//filter[@name='salesperson']" position="replace">
                <filter name="account_user_id" string="Account Manager" context="{'group_by': 'account_user_id'}"/>
            </xpath>
        </field>
    </record>

    <record id="view_invoice_tree_inherit_clx_invoice_policy" model="ir.ui.view">
        <field name="name">account.invoice.tree</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_invoice_tree"/>
        <field name="arch" type="xml">
            <xpath expr="//field[@name='invoice_date']" position="before">
                <field name="mgmt_company" optional = "show" />
            </xpath>
            <xpath expr="//field[@name='invoice_date_due']" position="after">
                <field name="invoice_month_year" optional = "hide" />
                <field name="invoice_period_verbal" optional = "show" />
                <field name="create_date" optional = "hide" />
                <field name="is_co_op" optional = "hide" />
            </xpath>           
            <xpath expr="//field[@name='invoice_date']" position="replace">
            </xpath>
            <xpath expr="//field[@name='invoice_date']" position="replace">
                <field name="post_date"/>
            </xpath>         

            <xpath expr="//field[@name='invoice_user_id']" position="replace">
                <field name="invoice_user_id" optional = "hide" />
                <field name="account_user_id" optional = "show" />
            </xpath>            
        </field>
    </record>
<!--    Add the Custom Filters for verticals-->
    <record id="clx_view_account_invoice_filter_invoice_table_filter" model="ir.ui.view">
        <field name="name">clx.account.invoice.select.invoice.table.filter</field>
        <field name="model">account.move</field>
        <field name="inherit_id" ref="account.view_account_invoice_filter"/>
        <field name="arch" type="xml">
            <filter name="duedate" position="after">
                <separator/>
                <filter name="clx_vertical_auto" string="Vertical - Auto" domain="[('partner_id.vertical', '=', 'auto')]"/>
                <filter name="clx_vertical_local" string="Vertical - Local" domain="[('partner_id.vertical', '=', 'local')]"/>
                <filter name="clx_vertical_res" string="Vertical - Residential" domain="[('partner_id.vertical', '=', 'res')]"/>
                <filter name="clx_vertical_srl" string="Vertical - Senior Living" domain="[('partner_id.vertical', '=', 'srl')]"/>

                <filter name="clx_email_sent_status" string="Email sent to Account Manager" domain="[('state', '=', 'email_sent')]"/>
                <filter name="clx_inv_approved" string="Invoice Approved by Account Manager" domain="[('state', '=', 'approved_draft')]"/>                
                <filter name="clx_is_co_op" string="CO-OP" domain="[('is_co_op', '=', True)]"/>
                <separator/>
            </filter>
        </field>
    </record>

    <record model="ir.actions.server" id="action_move_approve_by_sales">
            <field name="name">Approve invoice</field>
            <field name="model_id" ref="account.model_account_move"/>
            <field name="binding_model_id" ref="account.model_account_move" />
            <field name="state">code</field>
            <field name="code">
if records:
    action = records.button_approve_invoice()
            </field>
    </record>

    <act_window
        name="Send &amp; print"
        id="account.invoice_send"
        res_model="account.invoice.send"
        binding_model="account.move"
        binding_views="list"
        view_mode="form"
        target="new"
        context="{
            'default_template_id': ref('clx_invoice_policy.account_move_clx_email_template'),
            'mark_invoice_as_sent': True,
        }"
        groups="account.group_account_invoice"/>
</odoo>
