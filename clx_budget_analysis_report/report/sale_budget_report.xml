<?xml version="1.0" encoding="utf-8" ?>
<odoo>

    <record id="sale_budget_report_view_pivot" model="ir.ui.view">
        <field name="name">sale.budget.report.pivot</field>
        <field name="model">sale.budget.report</field>
        <field name="arch" type="xml">
            <pivot string="Sales Budget" disable_linking="True">
                <field name="wholesale_price" type="measure"/>
                <field name="management_fee" type="measure"/>
                <field name="price_unit" type="measure"/>
                <field name="start_date" interval="day" type="col"/>
                <field name="end_date" interval="day" type="col"/>
                <field name="partner_id" type="row"/>
                <field name="product_id" type="row"/>
            </pivot>
        </field>
    </record>


    <!--<record id="sale_budget_report_view_search" model="ir.ui.view">
        <field name="name">sale.budget.report.search</field>
        <field name="model">sale.budget.report</field>
        <field name="arch" type="xml">
            <search>
                <filter string="Client" name="partner_id"/>
            </search>
        </field>
    </record>-->

    <record id="sale_budget_report_action" model="ir.actions.act_window">
        <field name="name">Budget Report</field>
        <field name="res_model">sale.budget.report</field>
        <field name="view_mode">pivot</field>
        <field name="context"></field>
        <field name="domain">[]</field>
    </record>

    <!-- <record id="sale_budget_report_action_qweb" model="ir.actions.report">
        <field name="name">Budget Report(QWeb)</field>
        <field name="model">report.sale_subscription.budgets_report</field>
        <field name="report_type">qweb-html</field>
        <field name="context"></field>
        <field name="domain">[]</field>
    </record> -->

    <report
		id = "sale_budget_report_action_qweb"
		model = "budget.report.wizard"
		name = "clx_budget_analysis_report.report_budget_qweb"
		string = "Report"
		report_type = "qweb-html"/>

    <!--<menuitem id="budget_reporting" name="Reporting" parent="clx_budget_management.main_menu_sale_budget" sequence="3"/>
    <menuitem id="sale_budget_report_menu" name="Budget Report" parent="clx_budget_analysis_report.budget_reporting" action="clx_budget_analysis_report.sale_budget_report_action" sequence="1"/>-->
    <!-- Main template -->

    <template id="report_budget_qweb">
        <style type="text/css">
            .report-budgets-wrapper{
                overflow-x: scroll;
                font-family: Arial;
            }
            table.report-budgets{
                text-align:center;
                border-spacing: 0px;
                border-collapse: collapse;
            }

            table.report-budgets .moneys.retail{
                font-weight:600;
            }
            table.report-budgets th,td {
                padding:2px;
                border:1px solid;
                min-height:20px;
                font-size:10pt;
            }
            table.report-budgets th.moneys,td.moneys {
                min-width:50px;
            }            
            table.report-budgets th.names,td.names {
                min-width:150px;
                background-color:#dddddd;
            }
            table.report-budgets th.dates,td.dates {
                min-width:70px;
            }

            table.report-budgets th.total,td.total,tr.total {
                background-color:#dddddd;
                font-weight:600;
            }

            table.report-budgets th{
                background-color:#dddddd;
            }
            .table-report-cap{
                text-align: center;
                font-size: 21px;
                font-weight: 600;
            }
        </style>
        <div class="report-budgets-wrapper">
            <t t-foreach="companies" t-as="company_id">
                <t t-set="spk" t-value="companies[company_id]" />
                <table class="report-budgets">
                    <thead>
                        <tr>
                            <th rowspan="2">Subscription</th>
                            <t t-foreach="all_periods" t-as="period">
                                <th t-att-colspan="5 if fees_allowed else 3">
                                    <t t-esc="period"/>
                                </th>
                            </t>
                        </tr>
                        <tr>
                            <t t-foreach="all_periods" t-as="period">
                                <th>Retail</th>
                                <t t-if="fees_allowed">
                                    <th>Wholesale</th>
                                    <th>Management Fee</th>
                                </t>
                                <th>Start Date</th>
                                <th>End Date</th>
                            </t>
                        </tr>
                    </thead>
                    <tbody>
                        <a target="_blank" t-attf-href="/web#id={{spk['partner_id']}}&amp;model=res.partner&amp;view_type=form&amp;cids=1&amp;menu_id=294">
                            <div class="table-report-cap" t-esc="spk['company_name']" />
                        </a>                                
                        <t t-foreach="spk['subs']" t-as="line">
                            <tr>
                                <td class="names">
                                    <!-- <div t-esc="spk['subs'][line]" /> -->
                                    <a target="_blank" t-attf-href="/web#id={{spk['subs'][line]['subscription_id']}}&amp;action=433&amp;model=sale.subscription&amp;view_type=form&amp;cids=1&amp;menu_id=294">
                                        <div t-esc="spk['subs'][line]['description']" />
                                    </a>
                                </td>
                                <t t-foreach="all_periods" t-as="period">
                                    <t t-if="period in spk['subs'][line]">
                                        <t t-foreach="spk['subs'][line][period]" t-as="sub_period">
                                            <td class="moneys retail">
                                                <div t-esc="sub_period['price_unit']" />
                                            </td>
                                            <t t-if="fees_allowed">
                                                <!-- <div t-esc="sub_period"/> -->
                                                <td class="moneys">
                                                    <div t-esc="'PNS' if sub_period['management_fee_product']==False and sub_period['wholesale_price'] == False else  (sub_period['wholesale_price'] if sub_period['wholesale_price'] else '')"/>
                                                </td>
                                                <td class="moneys">
                                                    <div t-esc="'PNS' if sub_period['management_fee_product']==False and sub_period['management_fee'] == False else (sub_period['management_fee'] if sub_period['management_fee'] else '')" />
                                                </td>
                                            </t>
                                            <td class="dates">
                                                <div t-esc="sub_period['start_date']" />
                                            </td>
                                            <td class="dates">
                                                <div t-esc="sub_period['end_date']" />
                                            </td>
                                        </t>
                                    </t>
                                    <t t-else="">
                                        <td class="moneys"></td>
                                        <t t-if="fees_allowed">
                                            <td class="moneys"></td>
                                            <td class="moneys"></td>
                                        </t>
                                        <td class="dates"></td>
                                        <td class="dates"></td>
                                    </t>
                                </t>
                            </tr>
                        </t>
                        <tr class="total"> 
                            <td class="total moneys">Total</td>      
                            <t t-foreach="all_periods" t-as="period">
                                    <t t-set="total_retail" t-value="0.0" />
                                    <t t-set="total_wholesale" t-value="0.0" />
                                    <t t-set="total_mgmnt_fee" t-value="0.0" />
                                <t t-foreach="spk['subs']" t-as="line">
                                    <t t-if="period in spk['subs'][line]">
                                        <t t-foreach="spk['subs'][line][period]" t-as="sub_period">
                                            <t t-set="total_retail" t-value="total_retail+sub_period['price_unit']" />
                                            <t t-if="sub_period['wholesale_price']>0">
                                                <t t-set="total_wholesale" t-value="total_wholesale + sub_period['wholesale_price']" />
                                            </t> 
                                            <t t-if="sub_period['management_fee']>0">
                                                <t t-set="total_mgmnt_fee" t-value="total_mgmnt_fee + sub_period['management_fee']" />
                                            </t>
                                        </t>
                                    </t>
                                </t>
                                <td  class="total"><div t-esc="total_retail" /></td>
                                <t t-if="fees_allowed">
                                    <td  class="total moneys" ><div t-esc="round(total_wholesale,2)" /></td>
                                    <td  class="total moneys"><div t-esc="round(total_mgmnt_fee,2)" /></td>
                                </t>
                                <td class="dates"></td>
                                <td class="dates"></td>
                            </t>
                        </tr>
                    </tbody>
                </table>
            </t>
        </div>
    </template>

    <template id="report_budget_report_data_qweb_document">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <p>Report</p>
                <div t-field="doc.id" />
                <t t-foreach="get_all" t-as="rec">
                    <p>Ttt</p>
                    <div t-field="rec.name" />
                </t>
                <t t-foreach="spk" t-as="spp">
                    <p>Spk</p>
                    <div t-field="spp.name" />
                </t>
            </t>
        </t>
    </template>

    <template id="report_sale_order_subscription_lines">
        <t t-call="web.html_container">
            <t t-foreach="docs" t-as="doc">
                <t t-call="sale.report_sale_order_subscription_lines_document" t-lang="doc.partner_id.lang"/>
            </t>
        </t>
    </template>

    <!-- Translatable template -->
    <template id="report_sale_order_subscription_lines_document">
        <!-- Re-browse of the record with the partner lang -->
        <t t-set="doc" t-value="doc.with_context(lang=doc.partner_id.lang)" />
        <t t-call="web.external_layout">
            <div class="page">
                <div class="oe_structure"/>
                <div class="row">
                    <div class="col-6">
                        <strong t-if="doc.partner_shipping_id == doc.partner_invoice_id">Invoice and shipping address:</strong>
                        <strong t-if="doc.partner_shipping_id != doc.partner_invoice_id">Invoice address:</strong>
                        <div t-field="doc.partner_invoice_id" t-options="{&quot;no_marker&quot;: True}"/>
                    </div>
                </div>
                <div class="oe_structure"/>
            </div>
        </t>
    </template>
</odoo>